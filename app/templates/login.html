<!DOCTYPE html>
<html>
<head>
    <title>Login</title>
</head>
<body>
    <h2>Login to SUP Competition App</h2>
    <p>Please log in using your Strava account to continue.</p>
    <a href="/auth/strava/login">
        <button>Login with Strava</button>
    </a>
    <hr>
    <p><a href="/register">Or go to the old registration page (for testing)</a></p>
    <hr>
    <h3>Logout</h3>
    <form action="/auth/strava/logout" method="post" id="logoutForm">
        <button type="button" onclick="logoutUser()">Logout</button>
    </form>
    <script>
    async function logoutUser() {
        const token = localStorage.getItem('jwt_token'); // Assuming JWT is stored in localStorage
        if (!token) {
            alert("No token found. Are you logged in?");
            // Optionally redirect to login if no token is found
            // window.location.href = '/auth/display_login';
            return;
        }
        try {
            const response = await fetch('/auth/strava/logout', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            // Check if response is ok (status in the range 200-299)
            if (!response.ok) {
                // Try to parse error message from server if available
                let errorDetail = "Logout request failed.";
                try {
                    const errorResult = await response.json();
                    errorDetail = errorResult.detail || errorResult.msg || errorDetail;
                } catch (e) {
                    // Ignore if response is not JSON or error parsing
                }
                throw new Error(`Server responded with ${response.status}: ${errorDetail}`);
            }
            
            const result = await response.json();
            alert(result.msg || "Logged out successfully. Client should clear token.");
            localStorage.removeItem('jwt_token'); // Clear token on client side
            window.location.href = '/auth/display_login'; // Redirect to login
        } catch (error) {
            console.error('Logout failed:', error);
            alert(error.message || 'Logout failed.');
        }
    }
    </script>
</body>
</html>
